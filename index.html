<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MyConspect</title>
<style>
body { margin:0; padding:0; font-family:"Segoe UI",sans-serif; background:#f2f4f8; display:flex; align-items:center; justify-content:center; height:100vh; color:#333; flex-direction:column;}
.container { text-align:center; background:white; padding:40px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.1); max-width:400px;}
h1 { font-size:1.5em; margin-bottom:8px;}
p { font-size:1em;}
#versionText { font-size:0.9em; color:#666; margin-bottom:16px; }
.loader { border:6px solid #f3f3f3; border-top:6px solid #3498db; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:20px auto; display:none;}
@keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
.hidden { display:none; }
#connectBtn { background:#3498db; color:white; border:none; padding:12px 24px; border-radius:8px; font-size:16px; cursor:pointer; margin-top:16px; transition:0.3s;}
#connectBtn:hover { background:#2980b9; }
#retryBtn { background:#3498db; color:white; border:none; padding:10px 20px; border-radius:8px; font-size:14px; cursor:pointer; margin-top:12px; transition:0.3s;}
#retryBtn:hover { background:#2980b9; }

/* –ö–æ–Ω—Å–æ–ª—å */
#consoleBtn { position:fixed; top:16px; right:16px; width:36px; height:36px; padding:6px; border:none; background:transparent; cursor:pointer; z-index:1000;}
#consoleBtn svg { width:28px; height:28px; fill:#3498db;}
#consoleWindow { position:fixed; top:60px; right:20px; width:380px; height:300px; background:#1e1e1e; color:#dcdcdc; font-family:monospace; font-size:13px; border-radius:8px; padding:10px; box-shadow:0 8px 25px rgba(0,0,0,0.3); overflow:auto; display:none; flex-direction:column; z-index:999;}
#consoleWindow.visible { display:flex; }
#consoleHeader { display:flex; justify-content:flex-end; margin-bottom:6px;}
#clearConsoleBtn { background:#3498db; border:none; color:white; font-size:16px; width:32px; height:32px; border-radius:50%; cursor:pointer; box-shadow:0 3px 6px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center; transition:0.3s;}
#clearConsoleBtn:hover { background:#2980b9; transform:scale(1.1);}
#clearConsoleBtn:active { transform:scale(0.95);}
#logContainer { flex:1; overflow:auto;}
.log-entry { margin-bottom:6px; border-left:3px solid #3498db; padding-left:6px; word-break:break-word;}
.log-error { border-left-color:#e74c3c; color:#ff9e9e;}
.log-ok { border-left-color:#2ecc71; color:#a6f3b1; }

/* info.json —Ç–µ–∫—Å—Ç */
#infoText { position:fixed; bottom:10px; left:50%; transform:translateX(-50%); font-size:12px; color:#555; text-align:center; max-width:90%; line-height:1.4em; }
</style>
</head>
<body>

<div class="container" id="loading">
  <h1 id="statusText">MyConspect</h1>
  <p id="versionText"></p>
  <div class="loader" id="loader"></div>
  <button id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
</div>

<div class="container hidden" id="error">
  <h1>–£–ø—Å!</h1>
  <p>–ò–∑–≤–∏–Ω–∏—Ç–µ, –∫–æ–Ω—Å–ø–µ–∫—Ç—ã –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã.<br>–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É @TomAmmer</p>
  <button id="retryBtn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
</div>

<button id="consoleBtn" title="–ö–æ–Ω—Å–æ–ª—å">
  <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>
</button>

<div id="consoleWindow">
  <div id="consoleHeader">
    <button id="clearConsoleBtn" title="–û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å">üßπ</button>
  </div>
  <div id="logContainer"></div>
</div>

<p id="infoText"></p>

<script>
const targetUrl = "http://172.24.240.1:6808";
const timeout = 5000;

const loadingDiv = document.getElementById("loading");
const errorDiv = document.getElementById("error");
const loader = document.getElementById("loader");
const statusText = document.getElementById("statusText");
const versionText = document.getElementById("versionText");
const consoleBtn = document.getElementById("consoleBtn");
const consoleWindow = document.getElementById("consoleWindow");
const logContainer = document.getElementById("logContainer");
const connectBtn = document.getElementById("connectBtn");
const clearConsoleBtn = document.getElementById("clearConsoleBtn");
const retryBtn = document.getElementById("retryBtn");
const infoText = document.getElementById("infoText");

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
function log(message,type="info"){
  const entry=document.createElement("div");
  entry.classList.add("log-entry");
  if(type==="ok") entry.classList.add("log-ok");
  if(type==="error") entry.classList.add("log-error");
  entry.textContent=`[${new Date().toLocaleTimeString()}] ${message}`;
  logContainer.appendChild(entry);
  logContainer.scrollTop = logContainer.scrollHeight;

  let logs = JSON.parse(localStorage.getItem("serverLogs")||"[]");
  logs.push({message, type, time: new Date().toLocaleTimeString()});
  localStorage.setItem("serverLogs", JSON.stringify(logs));
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –∏ –¥–∞–Ω–Ω—ã—Ö
window.addEventListener("load", ()=>{
  let logs = JSON.parse(localStorage.getItem("serverLogs")||"[]");
  logs.forEach(l=>{
    const entry=document.createElement("div");
    entry.classList.add("log-entry");
    if(l.type==="ok") entry.classList.add("log-ok");
    if(l.type==="error") entry.classList.add("log-error");
    entry.textContent=`[${l.time}] ${l.message}`;
    logContainer.appendChild(entry);
  });
  // –í–µ—Ä—Å–∏—è
  fetch("versions.json")
    .then(res=>{
      if(!res.ok) throw new Error("–í–µ—Ä—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
      return res.json();
    })
    .then(data=>{
      versionText.textContent = `–í–µ—Ä—Å–∏—è: ${data.version}`;
      log(`–í–µ—Ä—Å–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ${data.version}`, "ok");
    })
    .catch(err=>{
      log(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–µ—Ä—Å–∏—é: ${err.message}`, "error");
      versionText.textContent = "–í–µ—Ä—Å–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞";
    });
  // info.json
  fetch("info.json")
    .then(res=>{
      if(!res.ok) throw new Error("info.json –Ω–µ –Ω–∞–π–¥–µ–Ω");
      return res.json();
    })
    .then(data=>{
      infoText.textContent = data.text || "";
    })
    .catch(err=>{
      log(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å info.json: ${err.message}`, "error");
      infoText.textContent = "";
    });
});

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Å–æ–ª–∏
consoleBtn.addEventListener("click", ()=>consoleWindow.classList.toggle("visible"));

// –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Å–æ–ª–∏
clearConsoleBtn.addEventListener("click", ()=>{
  logContainer.innerHTML = "";
  localStorage.removeItem("serverLogs");
});

// –§—É–Ω–∫—Ü–∏—è fetch —Å —Ç–∞–π–º–∞—É—Ç–æ–º
function fetchWithTimeout(url, timeout) {
  return new Promise((resolve, reject)=>{
    const timer = setTimeout(()=>reject(new Error("–¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è")), timeout);
    fetch(url)
      .then(res=>{
        clearTimeout(timer);
        if(!res.ok) reject(new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + res.status));
        else resolve(res);
      })
      .catch(err=>{
        clearTimeout(timer);
        reject(err);
      });
  });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
function connectToServer() {
  loader.style.display = "block";
  fetchWithTimeout(targetUrl, timeout)
    .then(()=>{
      log("–°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω.", "ok");
      setTimeout(()=>window.location.href=targetUrl, 3000);
    })
    .catch(err=>{
      log(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${err.message}`, "error");
      loadingDiv.classList.add("hidden");
      errorDiv.classList.remove("hidden");
    });
}

// –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
connectBtn.addEventListener("click", ()=>{
  statusText.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ";
  log("–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞...");
  loadingDiv.classList.remove("hidden");
  errorDiv.classList.add("hidden");
  connectToServer();
});

// –ö–Ω–æ–ø–∫–∞ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
retryBtn.addEventListener("click", ()=>{
  statusText.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ";
  log("–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞...");
  loadingDiv.classList.remove("hidden");
  errorDiv.classList.add("hidden");
  connectToServer();
});
</script>

</body>
</html>
